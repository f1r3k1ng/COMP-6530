---

- name: Change root user password
  user:
    name: root
    password: "{{ password | password_hash('sha512') }}"
    state: present 
  when: user_update | bool 

- name: Update root user .bashrc file
  copy:
    src: bashrc
    dest: /root/.bashrc
    owner: root
  when: bashrc_update | bool

- name: Change ubuntu user password
  user:
    name: ubuntu
    password: "{{ password | password_hash('sha512') }}"
    state: present
  when: user_update | bool

- name: Update ubuntu user .bashrc file
  copy:
    src: bashrc
    dest: /home/ubuntu/.bashrc
    owner: ubuntu
  when: bashrc_update | bool

- name: Add user {{ username }}
  user:
    name: "{{ username }}"
    shell: /bin/bash
    group: sudo
    password: "{{ password | password_hash('sha512') }}"
    state: present 
  when: user_update | bool

- name: Update {{ username }} user .bashrc file
  copy:
    src: bashrc
    dest: "/home/{{ username }}/.bashrc"
    owner: "{{ username }}"
  when: bashrc_update | bool

- name: Update the sshd config
  copy:
    src: sshd_config
    dest: /etc/ssh/sshd_config
  when: sshd_update | bool

- name: Restarting sshd
  service:
    name: sshd
    state: restarted
  when: sshd_update | bool

- name: Flush iptables
  iptables:
    flush: yes
  when: machine == "management" and iptables_flush | bool

- name: Setup forwarding in iptables
  iptables:
    chain: FORWARD
    in_interface: ens4
    out_interface: ens3
    match: state
    ctstate: RELATED,ESTABLISHED
    jump: ACCEPT
  when: machine == "management" and iptables_setup | bool

- name: Setup nat in iptables
  iptables:
    table: nat
    chain: POSTROUTING
    out_interface: ens4
    jump: MASQUERADE
  when: machine == "management" and iptables_setup | bool

- name: Enabling packet forwarding
  copy:
    src: ip_forward
    dest: /proc/sys/net/ipv4/ip_forward
  when: machine  == "management" and iptables_setup | bool

- name: Setup gateway on machines
  shell: ip route add default via "{{ management_ip }}"
  when: machine != "management" and gateway_setup | bool

...

