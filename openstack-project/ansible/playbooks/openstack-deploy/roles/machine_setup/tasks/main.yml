---

- name: Change root user password
  user:
    name: root
    password: "{{ password | password_hash('sha512') }}"
    state: present 
  when: user_update | bool 

- name: Update root user .bashrc file
  copy:
    src: bashrc
    dest: /root/.bashrc
    owner: root

- name: Change ubuntu user password
  user:
    name: ubuntu
    password: "{{ password | password_hash('sha512') }}"
    state: present
  when: user_update | bool

- name: Update ubuntu user .bashrc file
  copy:
    src: bashrc
    dest: /home/ubuntu/.bashrc
    owner: ubuntu

- name: Add user {{ username }}
  user:
    name: "{{ username }}"
    shell: /bin/bash
    group: sudo
    password: "{{ password | password_hash('sha512') }}"
    state: present 
  when: user_update | bool

- name: Update {{ username }} user .bashrc file
  copy:
    src: bashrc
    dest: "/home/{{ username }}/.bashrc"
    owner: "{{ username }}"

- name: Set correct timezone
  timezone:
    name: America/Chicago
    hwclock: local

- name: Update the sshd config
  copy:
    src: sshd_config
    dest: /etc/ssh/sshd_config

- name: Restarting sshd
  service:
    name: sshd
    state: restarted

- name: Flush iptables
  iptables:
    flush: yes
  when: machine == "management" and nat | bool

- name: Setup forwarding in iptables
  iptables:
    chain: FORWARD
    in_interface: ens4
    out_interface: ens3
    match: state
    ctstate: RELATED,ESTABLISHED
    jump: ACCEPT
  when: machine == "management" and nat | bool

- name: Setup nat in iptables
  iptables:
    table: nat
    chain: POSTROUTING
    out_interface: ens4
    jump: MASQUERADE
  when: machine == "management" and nat | bool

- name: Enabling packet forwarding
  copy:
    src: ip_forward
    dest: /proc/sys/net/ipv4/ip_forward
  when: machine  == "management"

- name: Copy over controller-cloud-init.example
  copy:
    src: controller-cloud-init.example
    dest: /etc/netplan/cloud-init.example
  when: machine == "controller"

- name: Copy over compute-cloud-init.example
  copy:
    src: compute-cloud-init.example
    dest: /etc/netplan/cloud-init.example
  when: machine == "compute"

- name: Copy over storage-cloud-init.example
  copy:
    src: storage-cloud-init.example
    dest: /etc/netplan/cloud-init.example
  when: machine == "storage"

- name: Print information
  debug:
    msg: "You should now go into the remote host and add the bridge to /etc/netplan/cloud-init.yml, an example template has been copied to the same location for you to follow"

- name: Wait for 10 seconds
  wait_for:
    timeout: 10
...

